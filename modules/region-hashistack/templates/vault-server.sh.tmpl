#!/bin/bash
set -e

exec > >(tee /var/log/startup-script.log|logger -t startup-script -s 2>/dev/console) 2>&1

mkdir /tmp/files
while [[ ! -f /tmp/files/consul-tls/consul-gossip.txt && ! -f /tmp/files/consul-tls/consul-agent-ca.pem ]]; do
  echo 'Waiting for Consul TLS Files'
  /snap/bin/gsutil -m rsync -r gs://${config_bucket} /tmp/files/
  sleep 5
done
chmod +x /tmp/files/*.sh

%{ if hashistack_image }
/usr/local/bin/run-consul.sh \
  --${consul_mode} \
  --cluster-tag-name "${consul_cluster_tag_name}"
if [[ ${vault_auto_unseal_key_project_id} == "" ||
      ${vault_auto_unseal_key_region} == "" ||
      ${vault_auto_unseal_key_ring} == "" ||
      ${vault_auto_unseal_crypto_key_name} == "" ]];then
  log_error "Auto Unseal parameters missing"
  exit 1
fi
/usr/local/bin/run-vault.sh \
  --vault-storage "${vault_storage}" \
  --tls-cert-file "/opt/vault/tls/vault.crt.pem" \
  --tls-key-file "/opt/vault/tls/vault.key.pem" \
  --auto-unseal-key-project-id "${vault_auto_unseal_key_project_id}" \
  --auto-unseal-key-region "${vault_auto_unseal_key_region}" \
  --auto-unseal-key-ring "${vault_auto_unseal_key_ring}" \
  --auto-unseal-crypto-key-name "${vault_auto_unseal_crypto_key_name}"
%{ else }
/tmp/files/boot-hashistack.sh \
  --prem-bucket "${prem_bucket}" \
  --consul-mode "${consul_mode}" \
  --consul-version "${consul_version}" \
  --consul-ent "${consul_ent}" \
  --consul-prem "${consul_prem}" \
  --consul-cluster-tag-name "${consul_cluster_tag_name}" \
  --vault-mode "${vault_mode}" \
  --vault-storage "${vault_storage}" \
  --vault-version "${vault_version}" \
  --vault-ent "${vault_ent}" \
  --vault-prem "${vault_prem}" \
  --auto-unseal-key-project-id "${vault_auto_unseal_key_project_id}" \
  --auto-unseal-key-region "${vault_auto_unseal_key_region}" \
  --auto-unseal-key-ring "${vault_auto_unseal_key_ring}" \
  --auto-unseal-crypto-key-name "${vault_auto_unseal_crypto_key_name}" \
  --nomad-mode "${nomad_mode}" \
  --nomad-version "${nomad_version}" \
  --nomad-ent "${nomad_ent}" \
  --nomad-prem "${nomad_prem}" \
  --nomad-num-servers "${nomad_num_servers}" \
  --nomad-cluster-tag-name "${nomad_cluster_tag_name}" \
  --nomad-acl-enabled "${nomad_acl_enabled}" \
  --consul-template "${consul_template_ver}" \
  --envconsul "${envconsul_ver}" \
  --terraform "${terraform_ver}" \
  --elk-stack "${elk_stack}"
%{ endif }